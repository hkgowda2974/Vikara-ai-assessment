<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SAMAY</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
:root {
  --bg: #edecea;
  --text: #1c1c1c;
  --text-mid: #555;
  --text-light: #bbb;
  --accent: #2D5A27;
  --accent2: #3A86FF;
  --font: 'DM Sans', sans-serif;
}
html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); font-family:var(--font); }

body::after {
  content:''; position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
  pointer-events:none; z-index:900; opacity:0.45;
}

.scene { width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }

/* FIX: consistent translate(-50%,-50%) on idle; snap to corner on other states */
.orb-wrap {
  position:absolute; width:280px; height:280px; top:50%; left:50%;
  transform:translate(-50%, -50%) scale(1);
  transition: top .72s cubic-bezier(.65,0,.35,1), left .72s cubic-bezier(.65,0,.35,1),
              transform .72s cubic-bezier(.65,0,.35,1), opacity .5s;
  z-index:20; cursor:pointer;
}
.scene.active .orb-wrap,
.scene.calendar .orb-wrap,
.scene.connecting .orb-wrap { top:22px; left:18px; transform:translate(0,0) scale(0.1714); }

.orb {
  position:relative; width:100%; height:100%; border-radius:50%; overflow:hidden;
  -webkit-mask-image: radial-gradient(circle, black 49%, transparent 50%);
  mask-image: radial-gradient(circle, black 49%, transparent 50%);
  animation: orbFloat 7s ease-in-out infinite, orbBreath 8s ease-in-out infinite;
  filter: drop-shadow(0 0 40px rgba(58,134,255,0.20)) drop-shadow(0 20px 48px rgba(0,0,0,0.22));
  transition: filter .5s;
}
.scene.active .orb, .scene.calendar .orb, .scene.connecting .orb {
  animation: orbFloatMini 5s ease-in-out infinite;
  filter: drop-shadow(0 2px 10px rgba(0,0,0,0.25));
}
@keyframes orbFloat    { 0%,100%{transform:translateY(0)}  50%{transform:translateY(-13px)} }
@keyframes orbFloatMini{ 0%,100%{transform:translateY(0)}  50%{transform:translateY(-3px)}  }
@keyframes orbBreath   { 0%,100%{transform:scale(1)} 33%{transform:scale(1.012)} 66%{transform:scale(0.995)} }

.orb-base { position:absolute; inset:0; background:radial-gradient(ellipse at 45% 55%, #1a3d16 0%, #0d2a0a 45%, #060f05 100%); }
.blobs { position:absolute; inset:-20%; width:140%; height:140%; filter:blur(48px) saturate(1.4); will-change:transform; }
.blob  { position:absolute; border-radius:50%; mix-blend-mode:screen; will-change:transform; }
.blob-1 { width:75%; height:75%; top:5%; left:0%; background:radial-gradient(circle,#4a9a3e 0%,#2D5A27 45%,transparent 72%); animation:blob1 18s ease-in-out infinite; opacity:.92; }
@keyframes blob1 { 0%{transform:translate(0%,0%) scale(1)} 20%{transform:translate(18%,12%) scale(1.08)} 40%{transform:translate(28%,-5%) scale(0.95)} 60%{transform:translate(10%,22%) scale(1.12)} 80%{transform:translate(-8%,8%) scale(1.04)} 100%{transform:translate(0%,0%) scale(1)} }
.blob-2 { width:70%; height:70%; top:20%; left:28%; background:radial-gradient(circle,#6ba3ff 0%,#3A86FF 40%,transparent 68%); animation:blob2 14s ease-in-out infinite; opacity:.85; }
@keyframes blob2 { 0%{transform:translate(0%,0%) scale(1)} 25%{transform:translate(-22%,15%) scale(1.10)} 50%{transform:translate(-8%,30%) scale(0.92)} 75%{transform:translate(15%,12%) scale(1.06)} 100%{transform:translate(0%,0%) scale(1)} }
.blob-3 { width:80%; height:65%; top:45%; left:10%; background:radial-gradient(circle,#e8ff9a 0%,#D4FC79 35%,#8ab82a 65%,transparent 78%); animation:blob3 22s ease-in-out infinite; opacity:.70; }
@keyframes blob3 { 0%{transform:translate(0%,0%) scale(1)} 30%{transform:translate(15%,-20%) scale(1.15)} 55%{transform:translate(-10%,-8%) scale(0.90)} 80%{transform:translate(8%,18%) scale(1.08)} 100%{transform:translate(0%,0%) scale(1)} }
.blob-4 { width:45%; height:45%; top:30%; left:38%; background:radial-gradient(circle,#7adc5e 0%,#3d8c2a 50%,transparent 70%); animation:blob4 10s ease-in-out infinite; opacity:.60; }
@keyframes blob4 { 0%{transform:translate(0%,0%) scale(1)} 20%{transform:translate(-30%,-20%) scale(1.20)} 40%{transform:translate(20%,-30%) scale(0.85)} 60%{transform:translate(25%,20%) scale(1.15)} 80%{transform:translate(-15%,25%) scale(0.92)} 100%{transform:translate(0%,0%) scale(1)} }
.blob-5 { width:55%; height:55%; top:0%; left:40%; background:radial-gradient(circle,#a8d4ff 0%,#5a9eff 30%,#2D5A27 65%,transparent 78%); animation:blob5 16s ease-in-out infinite reverse; opacity:.55; }
@keyframes blob5 { 0%{transform:translate(0%,0%) scale(1)} 25%{transform:translate(-20%,30%) scale(1.12)} 50%{transform:translate(10%,20%) scale(0.88)} 75%{transform:translate(20%,-10%) scale(1.10)} 100%{transform:translate(0%,0%) scale(1)} }
.blob-6 { width:50%; height:50%; top:55%; left:45%; background:radial-gradient(circle,#1a5ccc 0%,#0a2f80 55%,transparent 72%); animation:blob6 20s ease-in-out infinite; opacity:.75; mix-blend-mode:hard-light; }
@keyframes blob6 { 0%{transform:translate(0%,0%) scale(1)} 35%{transform:translate(-25%,-15%) scale(1.18)} 65%{transform:translate(15%,-25%) scale(0.88)} 100%{transform:translate(0%,0%) scale(1)} }
.orb-vignette { position:absolute; inset:0; border-radius:50%; background:radial-gradient(circle at 50% 50%,transparent 50%,rgba(0,0,0,0.45) 80%,rgba(0,0,0,0.75) 100%); pointer-events:none; }
.orb-grain { position:absolute; inset:0; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.72' numOctaves='4' seed='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23g)' opacity='1'/%3E%3C/svg%3E"); background-size:220px 220px; mix-blend-mode:overlay; opacity:.55; animation:grainShift .8s steps(1) infinite; pointer-events:none; }
@keyframes grainShift { 0%{background-position:0 0} 10%{background-position:-55px -25px} 20%{background-position:30px 60px} 30%{background-position:-80px 10px} 40%{background-position:20px -70px} 50%{background-position:-40px 50px} 60%{background-position:70px -30px} 70%{background-position:-10px 80px} 80%{background-position:50px -50px} 90%{background-position:-60px 20px} 100%{background-position:0 0} }
.orb-svg-grain { position:absolute; inset:0; pointer-events:none; opacity:.30; mix-blend-mode:soft-light; }
.orb-gloss { position:absolute; top:6%; left:8%; width:48%; height:38%; border-radius:50%; background:radial-gradient(ellipse at 35% 30%,rgba(255,255,255,0.28) 0%,rgba(255,255,255,0.08) 45%,transparent 70%); filter:blur(8px); pointer-events:none; animation:glossShift 12s ease-in-out infinite; }
@keyframes glossShift { 0%,100%{transform:translate(0%,0%) scale(1); opacity:.9} 40%{transform:translate(4%,6%) scale(1.1); opacity:1} 70%{transform:translate(-3%,2%) scale(.92); opacity:.8} }

/* ‚ïê‚ïê STATE 1 ‚Äî IDLE ‚ïê‚ïê */
.idle-bar {
  position:absolute; bottom:56px; left:50%; transform:translateX(-50%);
  display:flex; align-items:center; gap:10px;
  z-index:30; opacity:1; pointer-events:all;
  transition:opacity .3s, transform .3s;
}
.scene.active .idle-bar, .scene.calendar .idle-bar, .scene.connecting .idle-bar {
  opacity:0; pointer-events:none; transform:translateX(-50%) translateY(10px);
}
.btn-phone {
  width:50px; height:50px; border-radius:50%; border:none; background:#fff;
  box-shadow:0 1px 8px rgba(0,0,0,0.10),0 0 0 1px rgba(0,0,0,0.05);
  cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center;
  transition:background .15s, transform .15s;
}
.btn-phone:hover { background:#f5f5f5; transform:scale(1.04); }
.btn-phone svg { color:#111; }
.input-idle {
  width:240px; padding:13px 20px; border-radius:100px; border:none; background:#fff;
  box-shadow:0 1px 8px rgba(0,0,0,0.09),0 0 0 1px rgba(0,0,0,0.05);
  font-family:var(--font); font-size:15px; color:var(--text); outline:none;
  transition:box-shadow .2s;
}
.input-idle::placeholder { color:var(--text-light); }
.input-idle:focus { box-shadow:0 2px 16px rgba(0,0,0,0.12),0 0 0 1px rgba(0,0,0,0.08); }

/* ‚ïê‚ïê CONNECTING STATE ‚ïê‚ïê */
.connecting-ui {
  position:absolute; bottom:56px; left:50%; transform:translateX(-50%) translateY(10px);
  display:flex; flex-direction:column; align-items:center; gap:14px;
  z-index:30; opacity:0; pointer-events:none;
  transition:opacity .35s, transform .35s;
}
.scene.connecting .connecting-ui { opacity:1; pointer-events:none; transform:translateX(-50%) translateY(0); }

/* FIX: ripple uses translate(-50%,-50%) matching new orb center baseline */
.orb-ring {
  position:absolute; width:280px; height:280px; border-radius:50%;
  border:1.5px solid rgba(58,134,255,0.35); top:50%; left:50%;
  transform:translate(-50%,-50%) scale(1); opacity:0; pointer-events:none; z-index:15;
}
.scene.connecting .orb-ring { animation: ripple 2.2s ease-out infinite; }
.scene.connecting .orb-ring:nth-child(2) { animation-delay:.55s; border-color:rgba(45,154,62,0.28); }
.scene.connecting .orb-ring:nth-child(3) { animation-delay:1.1s; border-color:rgba(212,252,121,0.22); }
@keyframes ripple {
  0%   { transform:translate(-50%,-50%) scale(1);   opacity:.8; }
  100% { transform:translate(-50%,-50%) scale(1.55); opacity:0; }
}

.conn-pill {
  background:rgba(255,255,255,0.88); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(0,0,0,0.07); border-radius:100px; padding:10px 22px;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 4px 24px rgba(0,0,0,0.10); white-space:nowrap;
}
.conn-dot-wrap { display:flex; align-items:center; gap:4px; }
.conn-dot { width:5px; height:5px; border-radius:50%; background:var(--accent2); animation:connBounce 1.1s ease-in-out infinite; }
.conn-dot:nth-child(2){animation-delay:.18s; background:var(--accent);}
.conn-dot:nth-child(3){animation-delay:.36s; background:#8ab82a;}
@keyframes connBounce { 0%,80%,100%{transform:translateY(0); opacity:.4;} 40%{transform:translateY(-5px); opacity:1;} }
.conn-label { font-size:13.5px; font-weight:500; color:var(--text-mid); letter-spacing:0.1px; }

.btn-cancel {
  width:38px; height:38px; border-radius:50%; border:none; background:rgba(255,255,255,0.75);
  box-shadow:0 1px 8px rgba(0,0,0,0.10); cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:background .15s, transform .12s; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
}
.btn-cancel:hover { background:#fff; transform:scale(1.06); }
.btn-cancel svg { color:#aaa; }

/* ‚ïê‚ïê STATE 2 ‚Äî ACTIVE ‚ïê‚ïê */
.convo-area {
  position:absolute; inset:0; display:flex; flex-direction:column;
  padding:90px 28px 90px 24px; opacity:0; pointer-events:none;
  transition:opacity .42s .26s; z-index:10;
}
.scene.active .convo-area { opacity:1; pointer-events:all; }
.scene.calendar .convo-area, .scene.connecting .convo-area { opacity:0 !important; pointer-events:none !important; }

.transcript { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:18px; }
.transcript::-webkit-scrollbar { display:none; }
.msg { font-size:16px; line-height:1.68; color:var(--text); max-width:92%; animation:msgIn .38s cubic-bezier(.16,1,.3,1) both; }
.msg.user { align-self:flex-end; font-size:15px; color:var(--text-mid); }
.msg.ai   { align-self:flex-start; }
@keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.typing { display:flex; gap:5px; align-items:center; padding:3px 0; opacity:0; pointer-events:none; transition:opacity .22s; align-self:flex-start; }
.typing.show { opacity:1; }
.typing span { width:7px; height:7px; border-radius:50%; background:var(--text-light); animation:td 1.2s ease-in-out infinite; }
.typing span:nth-child(2){animation-delay:.18s} .typing span:nth-child(3){animation-delay:.36s}
@keyframes td { 0%,80%,100%{transform:translateY(0);opacity:.35} 40%{transform:translateY(-6px);opacity:1} }
.active-bar {
  position:absolute; bottom:28px; left:24px; right:24px;
  display:flex; align-items:center; gap:10px;
  z-index:30; opacity:0; transform:translateY(10px); pointer-events:none;
  transition:opacity .35s .22s, transform .35s .22s;
}
.scene.active .active-bar { opacity:1; transform:translateY(0); pointer-events:all; }
.scene.calendar .active-bar, .scene.connecting .active-bar { opacity:0 !important; pointer-events:none !important; transform:translateY(10px) !important; }

.btn-hangup {
  width:50px; height:50px; border-radius:50%; border:none; background:#fff;
  box-shadow:0 1px 8px rgba(0,0,0,0.10),0 0 0 1px rgba(0,0,0,0.05);
  cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center;
  transition:background .15s, transform .15s;
}
.btn-hangup:hover { background:#f5f5f5; transform:scale(1.04); }
.btn-hangup svg { color:#111; }
.input-active {
  flex:1; padding:13px 20px; border-radius:100px;
  border:1.5px solid rgba(60,130,220,0.55); background:#fff;
  font-family:var(--font); font-size:15px; color:var(--text); outline:none;
  box-shadow:0 0 0 3px rgba(60,130,220,0.09); transition:border-color .2s, box-shadow .2s;
}
.input-active::placeholder { color:var(--text-light); }
.input-active:focus { border-color:rgba(60,130,220,0.72); box-shadow:0 0 0 4px rgba(60,130,220,0.13); }

/* ‚ïê‚ïê STATE 3 ‚Äî CALENDAR ‚ïê‚ïê */
.cal-backdrop {
  position:absolute; inset:0;
  background: radial-gradient(ellipse at 20% 50%, rgba(106,163,255,0.15) 0%, transparent 50%),
              radial-gradient(ellipse at 80% 60%, rgba(74,154,62,0.12) 0%, transparent 50%),
              radial-gradient(ellipse at 55% 5%,  rgba(212,252,121,0.10) 0%, transparent 40%),
              #ece9e4;
  opacity:0; pointer-events:none; transition:opacity .5s .1s; z-index:9990;
}
.scene.calendar .cal-backdrop { opacity:1; }

.calendar-view {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .5s .1s; z-index:9999; padding-top:30px;
}
.scene.calendar .calendar-view { opacity:1; pointer-events:all; }

.cal-card {
  display:flex; width: min(90vw, 660px); height: min(75vh, 400px);
  border-radius:22px; overflow:hidden;
  box-shadow:0 12px 56px rgba(45,90,39,0.16),0 2px 10px rgba(0,0,0,0.08);
}

.cal-left {
  width:40%; flex-shrink:0;
  background: linear-gradient(155deg, #3d8430 0%, #2D5A27 50%, #1b3e17 100%);
  display:flex; flex-direction:column; padding:20px 16px 16px 16px;
  position:relative; overflow:hidden;
}
.cal-left::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(ellipse at 20% 20%, rgba(106,163,255,0.20) 0%, transparent 50%),
              radial-gradient(ellipse at 85% 85%, rgba(212,252,121,0.14) 0%, transparent 45%);
}
.cal-top-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; position:relative; z-index:1; }
.cal-month-label { font-size:15px; font-weight:600; color:rgba(255,255,255,0.95); letter-spacing:0.3px; }
.cal-nav-btn {
  width:26px; height:26px; border-radius:50%; border:none; background:rgba(255,255,255,0.14);
  cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background .15s, transform .12s;
}
.cal-nav-btn:hover { background:rgba(255,255,255,0.26); transform:scale(1.1); }
.cal-nav-btn svg { color:rgba(255,255,255,0.88); }
.cal-dow { display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:5px; position:relative; z-index:1; }
.cal-dow span { text-align:center; font-size:9px; font-weight:500; color:rgba(255,255,255,0.45); letter-spacing:.6px; text-transform:uppercase; }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; flex:1; align-content:start; position:relative; z-index:1; }
.cal-day {
  aspect-ratio:1; border-radius:50%; display:flex; align-items:center; justify-content:center;
  cursor:pointer; position:relative; transition:background .14s, transform .12s;
  font-size:11.5px; font-weight:400; color:rgba(255,255,255,0.65);
}
.cal-day:hover:not(.empty) { background:rgba(255,255,255,0.10); }
.cal-day.empty { cursor:default; pointer-events:none; }
.cal-day.today { color:#fff; font-weight:600; background:rgba(255,255,255,0.16); }
.cal-day.has-event {
  background: radial-gradient(circle, #D4FC79 0%, #9fd43a 100%);
  color:#1a3d16; font-weight:700; box-shadow: 0 2px 12px rgba(212,252,121,0.50); cursor:pointer;
}
.cal-day.has-event:hover { transform:scale(1.14); }
.cal-day.today:not(.has-event)::after {
  content:''; position:absolute; bottom:3px; width:3px; height:3px; border-radius:50%; background:#D4FC79;
}
.cal-right { flex:1; background:#fff; display:flex; flex-direction:column; overflow:hidden; }
.cal-right-top {
  display:flex; align-items:center; justify-content:flex-end; padding:14px 16px 8px; gap:10px;
  border-bottom:1px solid rgba(0,0,0,0.05);
}
.cal-icon-btn {
  width:28px; height:28px; border-radius:50%; border:none; background:transparent;
  display:flex; align-items:center; justify-content:justify-content; cursor:pointer; transition:background .15s;
}
.cal-icon-btn:hover { background:rgba(0,0,0,0.05); }
.cal-icon-btn svg { color:#bbb; }
.events-scroll { flex:1; overflow-y:auto; padding:6px 0 12px; }
.events-scroll::-webkit-scrollbar { display:none; }
.ev-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:8px; color:#ccc; font-size:12.5px; }
.ev-empty svg { opacity:.25; }
.ev-row {
  display:flex; align-items:flex-start; gap:10px; padding:10px 16px; cursor:pointer;
  transition:background .14s; position:relative;
}
.ev-row:hover { background:rgba(45,90,39,0.04); }
.ev-row.future::before {
  content:''; position:absolute; left:0; top:10px; bottom:10px;
  width:3px; background:#D4FC79; border-radius:0 2px 2px 0;
}
.ev-date-label { min-width:42px; text-align:right; padding-top:1px; font-size:10.5px; font-weight:500; color:#bbb; flex-shrink:0; }
.ev-dot { width:26px; height:26px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; margin-top:1px; }
.ev-dot svg { width:12px; height:12px; color:#fff; }
.ev-body { flex:1; min-width:0; }
.ev-title { font-size:13px; font-weight:600; color:#1c1c1c; line-height:1.25; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ev-time  { font-size:11px; color:#aaa; margin-top:1px; }
.ev-badge { align-self:flex-start; margin-top:3px; flex-shrink:0; padding:2px 8px; border-radius:100px; font-size:9.5px; font-weight:600; letter-spacing:.3px; }
.badge-done   { background:rgba(0,0,0,0.05); color:#bbb; }
.badge-future { background:rgba(212,252,121,0.30); color:#4a7a1a; }
.ev-divider { height:1px; background:rgba(0,0,0,0.05); margin:0 16px; }

/* ‚ïê‚ïê BACK BUTTON ‚ïê‚ïê */
.btn-back {
  position:fixed; top:18px; right:18px; z-index:99999;
  padding:8px 18px; border-radius:100px; border:none;
  background:rgba(255,255,255,0.85); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  font-family:var(--font); font-size:13px; font-weight:500; color:var(--text-mid);
  cursor:pointer; box-shadow:0 2px 12px rgba(0,0,0,0.10);
  opacity:0; pointer-events:none; transition:opacity .35s, transform .25s;
  transform:translateY(-8px);
}
.scene.calendar .btn-back { opacity:1; pointer-events:all; transform:translateY(0); }
.btn-back:hover { background:#fff; }

/* ‚ïê‚ïê DEBUG OVERLAY ‚ïê‚ïê */
.debug-overlay {
  position:fixed; top:12px; right:12px; z-index:99999;
  background:rgba(0,0,0,0.82); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  color:#D4FC79; font-family:monospace; font-size:11px; line-height:1.7;
  padding:12px 16px; border-radius:14px; max-width:300px;
  border:1px solid rgba(212,252,121,0.25);
  opacity:0; transition:opacity .3s; pointer-events:none;
}
.debug-overlay.show { opacity:1; pointer-events:all; }
.debug-overlay .db-head { color:#fff; font-weight:700; font-size:12px; margin-bottom:6px; letter-spacing:.3px; font-family:'DM Sans',sans-serif; }
.debug-overlay .db-row  { display:flex; gap:8px; margin-bottom:1px; }
.debug-overlay .db-key  { color:#888; min-width:52px; flex-shrink:0; }
.debug-overlay .db-val  { color:#D4FC79; word-break:break-all; }
.debug-overlay .db-ok   { color:#7adc5e; }
.debug-overlay .db-warn { color:#ffb347; }
.debug-overlay .db-close {
  position:absolute; top:8px; right:10px; cursor:pointer; color:#555;
  font-size:14px; pointer-events:all; line-height:1;
}
.debug-overlay .db-close:hover { color:#fff; }

/* ‚ïê‚ïê TOAST ‚Äî FIX: z-index above calendar overlay ‚ïê‚ïê */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(52px);
  background:rgba(18,18,18,0.84); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  color:#fff; padding:9px 20px; border-radius:100px; font-size:12.5px; z-index:99998;
  transition:transform .35s cubic-bezier(.16,1,.3,1); white-space:nowrap;
}
.toast.show { transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="orb-noise" x="0%" y="0%" width="100%" height="100%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="0.65 0.68" numOctaves="4" seed="5" stitchTiles="stitch" result="noise">
        <animate attributeName="seed" values="5;12;7;19;3;5" dur="4s" repeatCount="indefinite"/>
      </feTurbulence>
      <feColorMatrix type="saturate" values="0" in="noise" result="grey"/>
      <feComponentTransfer in="grey" result="boosted">
        <feFuncR type="linear" slope="1.4" intercept="-0.2"/>
        <feFuncG type="linear" slope="1.4" intercept="-0.2"/>
        <feFuncB type="linear" slope="1.4" intercept="-0.2"/>
      </feComponentTransfer>
      <feBlend in="SourceGraphic" in2="boosted" mode="overlay" result="blended"/>
      <feComposite in="blended" in2="SourceGraphic" operator="in"/>
    </filter>
  </defs>
</svg>

<div class="scene" id="scene">
  <div class="orb-ring"></div>
  <div class="orb-ring"></div>
  <div class="orb-ring"></div>
  <div class="cal-backdrop"></div>

  <div class="orb-wrap" id="orbWrap">
    <div class="orb" id="orb">
      <div class="orb-base"></div>
      <div class="blobs" id="blobs">
        <div class="blob blob-1"></div><div class="blob blob-2"></div>
        <div class="blob blob-3"></div><div class="blob blob-4"></div>
        <div class="blob blob-5"></div><div class="blob blob-6"></div>
      </div>
      <div class="orb-vignette"></div>
      <div class="orb-grain"></div>
      <svg class="orb-svg-grain" viewBox="0 0 280 280" xmlns="http://www.w3.org/2000/svg">
        <rect width="280" height="280" fill="white" filter="url(#orb-noise)" opacity="0.6"/>
      </svg>
      <div class="orb-gloss"></div>
    </div>
  </div>

  <!-- STATE 1: IDLE -->
  <div class="idle-bar" id="idleBar">
    <button class="btn-phone" id="callBtn" title="Start voice call">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.25 11.36 11.36 0 003.56.57 1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.2 2.45.57 3.57a1 1 0 01-.25 1.01l-2.2 2.21z"/>
      </svg>
    </button>
    <input class="input-idle" id="idleInput" type="text" placeholder="Or type a message‚Ä¶" autocomplete="off" spellcheck="false"/>
  </div>

  <!-- CONNECTING UI -->
  <div class="connecting-ui" id="connectingUi">
    <div class="conn-pill">
      <div class="conn-dot-wrap">
        <div class="conn-dot"></div><div class="conn-dot"></div><div class="conn-dot"></div>
      </div>
      <span class="conn-label" id="connLabel">Connecting‚Ä¶</span>
    </div>
    <button class="btn-cancel" id="cancelBtn" title="Cancel">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- STATE 2: ACTIVE -->
  <div class="convo-area">
    <div class="transcript" id="transcript">
      <div class="typing" id="typing"><span></span><span></span><span></span></div>
    </div>
  </div>
  <div class="active-bar">
    <button class="btn-hangup" id="hangupBtn" title="End call">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 012 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.42 19.42 0 013.43 9.64a19.86 19.86 0 01-3.07-8.67A2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.18 7.91"/>
        <line x1="1" y1="1" x2="23" y2="23"/>
      </svg>
    </button>
    <input class="input-active" id="activeInput" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" spellcheck="false"/>
  </div>

  <!-- STATE 3: CALENDAR -->
  <div class="calendar-view" id="calendarView">
    <div class="cal-card">
      <div class="cal-left">
        <div class="cal-top-row">
          <button class="cal-nav-btn" id="calPrevBtn" title="Previous month">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
          <span class="cal-month-label" id="calMonthLabel"></span>
          <button class="cal-nav-btn" id="calNextBtn" title="Next month">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
          </button>
        </div>
        <div class="cal-dow">
          <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div class="cal-right">
        <div class="cal-right-top">
          <button class="cal-icon-btn" title="Search">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </button>
          <button class="cal-icon-btn" title="More options">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
          </button>
        </div>
        <div class="events-scroll" id="eventsScroll">
          <div class="ev-empty" id="evEmpty">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span>No events scheduled</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FIX: Back button to escape calendar view, outside .scene so z-index works cleanly -->
<button class="btn-back" id="backBtn">‚Üê Back</button>

<div class="debug-overlay" id="debugOverlay">
  <div class="db-close" id="debugClose">‚úï</div>
  <div class="db-head">üõ† Event Debug</div>
  <div class="db-row"><span class="db-key">title</span><span class="db-val" id="db-title">‚Äî</span></div>
  <div class="db-row"><span class="db-key">date</span><span class="db-val" id="db-date">‚Äî</span></div>
  <div class="db-row"><span class="db-key">time</span><span class="db-val" id="db-time">‚Äî</span></div>
  <div class="db-row"><span class="db-key">source</span><span class="db-val" id="db-source">‚Äî</span></div>
  <div class="db-row"><span class="db-key">gcalURL</span><span class="db-val" id="db-url">‚Äî</span></div>
  <div class="db-row"><span class="db-key">account</span><span class="db-val" id="db-account">‚Äî</span></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ASSISTANT_ID   = "6c8c6780-375e-4fde-b202-3403eb568b1e";
const PUBLIC_KEY     = "dfaf2ad6-2a10-432c-9c26-28adf816c6e3";
const CALENDAR_EMAIL = '1mp22cs021@gmail.com';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let vapi           = null;   // single instance, never nulled after first creation
let VapiClass      = null;
let vapiWired      = false;  // wireVapi() runs exactly once
let appState       = 'idle';
let scheduledEvent = null;
let calYear        = new Date().getFullYear();
let calMonth       = new Date().getMonth();
let pendingEvent   = null;
let assistantBuffer = '';
let allUserSpeech   = '';
let userUtterances  = [];
let toastTimer      = null;  // FIX: clear old timer before showing new toast

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM REFS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const scene        = document.getElementById("scene");
const transcript   = document.getElementById("transcript");
const typing       = document.getElementById("typing");
const activeInput  = document.getElementById("activeInput");
const idleInput    = document.getElementById("idleInput");
const callBtn      = document.getElementById("callBtn");
const hangupBtn    = document.getElementById("hangupBtn");
const cancelBtn    = document.getElementById("cancelBtn");
const backBtn      = document.getElementById("backBtn");
const blobs        = document.getElementById("blobs");
const toastEl      = document.getElementById("toast");
const calGrid      = document.getElementById("calGrid");
const calLabel     = document.getElementById("calMonthLabel");
const eventsScroll = document.getElementById("eventsScroll");
const evEmpty      = document.getElementById("evEmpty");
const connLabel    = document.getElementById("connLabel");

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARALLAX ORB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let mx=0, my=0, tx=0, ty=0;
document.addEventListener('mousemove', e => {
  if(appState !== 'idle') return; // FIX: skip parallax when orb is corner-pinned
  const r = document.getElementById("orb").getBoundingClientRect();
  if(!r.width) return;
  mx = Math.max(-1, Math.min(1, (e.clientX - r.left - r.width/2)  / (r.width/2)));
  my = Math.max(-1, Math.min(1, (e.clientY - r.top  - r.height/2) / (r.height/2)));
});

(function orbTick(){
  tx += (mx - tx) * 0.04;
  ty += (my - ty) * 0.04;
  // FIX: always include base offset; was '' which caused layout jump
  blobs.style.transform = `translate(calc(-20% + ${appState === 'idle' ? tx*10 : 0}px), calc(-20% + ${appState === 'idle' ? ty*8 : 0}px))`;
  requestAnimationFrame(orbTick);
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showToast(msg, d=3000){
  if(toastTimer) clearTimeout(toastTimer); // FIX: cancel previous timer
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  toastTimer = setTimeout(() => { toastEl.classList.remove("show"); toastTimer = null; }, d);
}

function setState(s){
  appState = s;
  scene.classList.remove('active','connecting','calendar');
  if(s === 'connecting') scene.classList.add('connecting');
  if(s === 'active')     scene.classList.add('active');
  if(s === 'calendar')   scene.classList.add('calendar');
  // Reset parallax when leaving idle so blobs don't stay offset
  if(s !== 'idle'){ mx=0; my=0; }
}

function goConnecting(){ connLabel.textContent = 'Connecting‚Ä¶'; setState('connecting'); }
function goActive(){ setState('active'); setTimeout(() => activeInput.focus(), 680); }

function goIdle(){
  setState('idle');
  // FIX: safe child removal without mutating while iterating
  const children = Array.from(transcript.children);
  children.forEach(c => { if(c !== typing) transcript.removeChild(c); });
  typing.classList.remove("show");
  activeInput.value = "";
  idleInput.value   = "";
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DEBUG OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showDebug(ev, source){
  const pad = n => String(n).padStart(2,'0');
  const d   = ev.date;
  const dateStr = d ? `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}` : '??';
  const url = `https://calendar.google.com/calendar/r/day/${dateStr}?authuser=${encodeURIComponent(CALENDAR_EMAIL)}`;

  document.getElementById('db-title').textContent  = ev.title || '(empty)';
  document.getElementById('db-title').className    = 'db-val ' + (ev.title && ev.title !== 'Meeting' ? 'db-ok' : 'db-warn');
  document.getElementById('db-date').textContent   = d ? d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}) : '(none)';
  document.getElementById('db-date').className     = 'db-val ' + (d ? 'db-ok' : 'db-warn');
  document.getElementById('db-time').textContent   = ev.time || '(none / all day)';
  document.getElementById('db-time').className     = 'db-val ' + (ev.time ? 'db-ok' : 'db-warn');
  document.getElementById('db-source').textContent = source || 'unknown';
  document.getElementById('db-source').className   = 'db-val ' + (source === 'tool-call' ? 'db-ok' : 'db-warn');
  document.getElementById('db-url').textContent    = url;
  document.getElementById('db-account').textContent = `authuser=${CALENDAR_EMAIL}`;
  document.getElementById('db-account').className  = 'db-val db-ok';
  document.getElementById('debugOverlay').classList.add('show');
}

// FIX: JS event listener instead of inline onclick (CSP-safe)
document.getElementById('debugClose').addEventListener('click', () => {
  document.getElementById('debugOverlay').classList.remove('show');
});

function goCalendar(event, source){
  console.log('[SAMAY] goCalendar:', event);
  scheduledEvent = event;
  calYear  = event.date.getFullYear();
  calMonth = event.date.getMonth();
  renderCalendar();
  renderEvents();
  showDebug(event, source || 'unknown');
  setState('calendar');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TRANSCRIPT UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showTyping(v){
  if(!transcript.contains(typing)) transcript.appendChild(typing);
  typing.classList.toggle("show", v);
  transcript.scrollTop = transcript.scrollHeight;
}

function addMsg(role, text){
  if(!text || !text.trim()) return; // FIX: skip empty messages
  if(transcript.contains(typing)) transcript.removeChild(typing);
  const d = document.createElement("div");
  d.className   = "msg " + role;
  d.textContent = text; // textContent = XSS-safe
  transcript.appendChild(d);
  transcript.appendChild(typing);
  transcript.scrollTop = transcript.scrollHeight;
}

function typeWrite(text, speed=14){
  return new Promise(res => {
    if(!text){ res(); return; } // FIX: guard null/empty
    if(transcript.contains(typing)) transcript.removeChild(typing);
    const d = document.createElement("div");
    d.className = "msg ai";
    transcript.appendChild(d);
    transcript.appendChild(typing);
    let i = 0;
    const tick = () => {
      if(i < text.length){ d.textContent += text[i++]; transcript.scrollTop = transcript.scrollHeight; setTimeout(tick, speed); }
      else res();
    };
    tick();
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPOKEN NUMBER ‚Üí INTEGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function spokenToNum(str){
  if(!str) return NaN;
  str = str.toLowerCase().trim().replace(/[- ]+/g, ' ');
  if(/^\d+$/.test(str)) return parseInt(str, 10);

  const ones = {
    zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,
    ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,
    seventeen:17,eighteen:18,nineteen:19,
    first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,eighth:8,
    ninth:9,tenth:10,eleventh:11,twelfth:12,thirteenth:13,fourteenth:14,
    fifteenth:15,sixteenth:16,seventeenth:17,eighteenth:18,nineteenth:19
  };
  const tens = { twenty:20,thirty:30,twentieth:20,thirtieth:30 };
  const compounds = {
    'twenty one':21,'twenty first':21,'twenty two':22,'twenty second':22,
    'twenty three':23,'twenty third':23,'twenty four':24,'twenty fourth':24,
    'twenty five':25,'twenty fifth':25,'twenty six':26,'twenty sixth':26,
    'twenty seven':27,'twenty seventh':27,'twenty eight':28,'twenty eighth':28,
    'twenty nine':29,'twenty ninth':29,'thirty one':31,'thirty first':31
  };

  if(ones[str]      !== undefined) return ones[str];
  if(tens[str]      !== undefined) return tens[str];
  if(compounds[str] !== undefined) return compounds[str];

  const parts = str.split(' ');
  if(parts.length === 2){
    const t = tens[parts[0]], o = ones[parts[1]];
    if(t !== undefined && o !== undefined) return t + o;
  }
  return NaN;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TODAY MIDNIGHT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function todayMidnight(){
  const t = new Date();
  t.setHours(0,0,0,0);
  return t;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DATE PARSER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseDateFromText(text){
  if(!text) return null;
  const months = {
    jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,
    jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,september:8,
    oct:9,october:9,nov:10,november:10,dec:11,december:11
  };
  const today = todayMidnight();
  const lower = text.toLowerCase();

  const spokenDay =
    '(?:twenty|thirty)[- ](?:first|second|third|fourth|fifth|sixth|seventh|eighth|ninth|one|two|three|four|five|six|seven|eight|nine)' +
    '|thirty[- ](?:first|one)' +
    '|(?:first|second|third|fourth|fifth|sixth|seventh|eighth|ninth|tenth|eleventh|twelfth|thirteenth|fourteenth|fifteenth|sixteenth|seventeenth|eighteenth|nineteenth|twentieth|thirtieth)' +
    '|(?:twenty|thirty)' +
    '|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen';
  const numDay  = '\\d{1,2}(?:st|nd|rd|th)?';
  const dayPat  = `(?:${spokenDay}|${numDay})`;
  const mNames  = 'january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|jun|jul|aug|sep|oct|nov|dec';
  const r1 = new RegExp(`(${mNames})\\s+(${dayPat})`, 'gi');
  const r2 = new RegExp(`(${dayPat})\\s+(?:of\\s+)?(${mNames})`, 'gi');

  let lastMatch = null, lastIndex = -1, m;
  while((m = r1.exec(lower)) !== null){
    if(m.index > lastIndex){ lastIndex = m.index; lastMatch = { mStr: m[1], dayStr: m[2] }; }
  }
  while((m = r2.exec(lower)) !== null){
    if(m.index > lastIndex){ lastIndex = m.index; lastMatch = { mStr: m[2], dayStr: m[1] }; }
  }

  if(lastMatch){
    const mIdx   = months[lastMatch.mStr.toLowerCase().replace(/\./g,'')];
    const rawDay = lastMatch.dayStr.toLowerCase().trim();
    let day = spokenToNum(rawDay);
    if(isNaN(day)) day = spokenToNum(rawDay.replace(/(st|nd|rd|th)$/, '').trim());
    if(isNaN(day)) day = parseInt(rawDay, 10);
    if(mIdx !== undefined && !isNaN(day) && day >= 1 && day <= 31){
      let d = new Date(today.getFullYear(), mIdx, day);
      if(d < today) d.setFullYear(today.getFullYear() + 1);
      return d;
    }
  }

  if(lower.includes('tomorrow'))  { const d = new Date(today); d.setDate(today.getDate()+1); return d; }
  if(lower.includes('next week')) { const d = new Date(today); d.setDate(today.getDate()+7); return d; }
  if(lower.includes('today'))     { return new Date(today); }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TIME PARSER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseSpokenTime(text){
  if(!text) return null;
  const lower = text.toLowerCase();
  const numMatch = lower.match(/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/);
  if(numMatch) return numMatch[1] + ':' + (numMatch[2]||'00') + ' ' + numMatch[3].toUpperCase();

  const hourWords = {one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12};
  const minWords  = {
    'oh':0,'zero':0,'five':5,'ten':10,'fifteen':15,'twenty':20,
    'twenty five':25,'twenty-five':25,'thirty':30,
    'thirty five':35,'thirty-five':35,'forty':40,
    'forty five':45,'forty-five':45,'fifty':50,'fifty five':55,'fifty-five':55
  };

  const spoken = lower.match(
    /\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s+(fifty[- ]five|forty[- ]five|thirty[- ]five|twenty[- ]five|fifty|forty|thirty|twenty|fifteen|ten|oh|zero|five)\s*(am|pm)\b/
  );
  if(spoken){
    const h = hourWords[spoken[1]], key = spoken[2].replace('-',' ');
    return `${h}:${String(minWords[key]||0).padStart(2,'0')} ${spoken[3].toUpperCase()}`;
  }
  const simple = lower.match(/\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s*(am|pm)\b/);
  if(simple) return `${hourWords[simple[1]]}:00 ${simple[2].toUpperCase()}`;
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEXT-MODE SCHEDULE PARSER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseScheduleFromUserInput(text){
  const eventDate = parseDateFromText(text);
  if(!eventDate) return null;
  const time  = parseSpokenTime(text);
  const q     = text.match(/"([^"]+)"/);
  const kw    = text.match(/\b(meeting|call|session|interview|appointment|standup|review|demo|lunch|dinner|coffee|sync|workshop|webinar|presentation|consultation)\b/i);
  const title = q ? q[1] : kw ? kw[0].charAt(0).toUpperCase()+kw[0].slice(1) : 'Scheduled Event';
  return { title, date: eventDate, time, gcalLink: null };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALENDAR RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MONTHS_SHORT = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function renderCalendar(){
  const today       = new Date();
  const firstDay    = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  calLabel.textContent = `${MONTHS_SHORT[calMonth]}. ${calYear}`;
  calGrid.innerHTML = '';
  for(let i=0; i<firstDay; i++){
    const e = document.createElement('div'); e.className='cal-day empty'; calGrid.appendChild(e);
  }
  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div');
    cell.className   = 'cal-day';
    cell.textContent = d;
    if(d===today.getDate() && calMonth===today.getMonth() && calYear===today.getFullYear()) cell.classList.add('today');
    if(scheduledEvent){
      const ev = scheduledEvent.date;
      if(d===ev.getDate() && calMonth===ev.getMonth() && calYear===ev.getFullYear()){
        cell.classList.add('has-event');
        cell.addEventListener('click', openGoogleCalendar);
      }
    }
    calGrid.appendChild(cell);
  }
}

// FIX: JS listeners instead of inline onclick for CSP safety
document.getElementById('calPrevBtn').addEventListener('click', () => changeMonth(-1));
document.getElementById('calNextBtn').addEventListener('click', () => changeMonth(1));

function changeMonth(dir){
  calMonth += dir;
  if(calMonth > 11){ calMonth=0; calYear++; }
  if(calMonth < 0) { calMonth=11; calYear--; }
  renderCalendar();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENTS RENDER ‚Äî FIX: DOM-safe, XSS-safe (textContent)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderEvents(){
  Array.from(eventsScroll.children).forEach(c => { if(c !== evEmpty) eventsScroll.removeChild(c); });
  if(!scheduledEvent){ evEmpty.style.display='flex'; return; }
  evEmpty.style.display = 'none';

  const ev         = scheduledEvent;
  const evMidnight = new Date(ev.date); evMidnight.setHours(0,0,0,0);
  const isFuture   = evMidnight >= todayMidnight();
  const dateLabel  = ev.date.toLocaleDateString('en-US',{month:'short',day:'numeric'});

  // Main event row (XSS-safe: textContent used for user data)
  const row = document.createElement('div');
  row.className = 'ev-row' + (isFuture ? ' future' : '');
  row.addEventListener('click', openGoogleCalendar);

  const dl = document.createElement('div'); dl.className='ev-date-label'; dl.textContent=dateLabel;
  const dot = document.createElement('div'); dot.className='ev-dot'; dot.style.background='#2D5A27';
  dot.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;
  const body = document.createElement('div'); body.className='ev-body';
  const titleEl = document.createElement('div'); titleEl.className='ev-title'; titleEl.textContent=ev.title;
  const timeEl  = document.createElement('div'); timeEl.className='ev-time';  timeEl.textContent=ev.time||'All day';
  body.appendChild(titleEl); body.appendChild(timeEl);
  const badge = document.createElement('div');
  badge.className='ev-badge '+(isFuture?'badge-future':'badge-done');
  badge.textContent=isFuture?'Upcoming':'Done';
  row.appendChild(dl); row.appendChild(dot); row.appendChild(body); row.appendChild(badge);
  eventsScroll.appendChild(row);

  const divider = document.createElement('div'); divider.className='ev-divider';
  eventsScroll.appendChild(divider);

  // "Open in Google Calendar" row
  const open = document.createElement('div'); open.className='ev-row';
  open.addEventListener('click', openGoogleCalendar);
  const dl2 = document.createElement('div'); dl2.className='ev-date-label';
  const dot2 = document.createElement('div'); dot2.className='ev-dot'; dot2.style.background='#3A86FF';
  dot2.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;
  const body2=document.createElement('div'); body2.className='ev-body';
  const ot=document.createElement('div'); ot.className='ev-title'; ot.style.color='#3A86FF'; ot.textContent='Open in Google Calendar';
  const os=document.createElement('div'); os.className='ev-time'; os.textContent='Tap to view & edit';
  body2.appendChild(ot); body2.appendChild(os);
  open.appendChild(dl2); open.appendChild(dot2); open.appendChild(body2);
  eventsScroll.appendChild(open);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GOOGLE CALENDAR LINK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openGoogleCalendar(){
  if(!scheduledEvent) return;
  // FIX: noopener for security
  if(scheduledEvent.gcalLink){ window.open(scheduledEvent.gcalLink, '_blank', 'noopener'); return; }
  const ev=scheduledEvent, d=ev.date;
  const pad=n=>String(n).padStart(2,'0');
  const dateStr=`${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
  const url=`https://calendar.google.com/calendar/r/day/${dateStr}?authuser=${encodeURIComponent(CALENDAR_EMAIL)}`;
  window.open(url, '_blank', 'noopener');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEXT-MODE FALLBACK HANDLER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function handleTextInput(text){
  if(!text || !text.trim()) return;
  addMsg("user", text);
  if(/schedule|book|set.?up|meeting|appointment|call|remind/i.test(text)){
    showTyping(true);
    setTimeout(async () => {
      const ev = parseScheduleFromUserInput(text);
      const response = ev
        ? `Got it! I've scheduled "${ev.title}" for ${ev.date.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}${ev.time?' at '+ev.time:''}. Opening your calendar now.`
        : "Sure! What date and time works for this?";
      showTyping(false);
      await typeWrite(response);
      if(ev){
        setTimeout(() => {
          showToast(`‚úÖ "${ev.title}" scheduled!`, 2500);
          setTimeout(() => goCalendar(ev, 'text-input'), 600);
        }, 400);
      }
    }, 800);
  } else {
    showTyping(true);
    setTimeout(async () => {
      showTyping(false);
      await typeWrite("Tell me what you'd like to schedule ‚Äî the event name, date, and time!");
    }, 800);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VAPI ‚Äî LOAD BUNDLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadVapi(){
  import("./vapi-bundle.js").then(mod => {
    VapiClass = mod.default ?? mod.Vapi ?? mod.VapiSDK;
    if(typeof VapiClass !== "function" && VapiClass?.default) VapiClass = VapiClass.default;
    if(typeof VapiClass !== "function"){ console.warn('[SAMAY] No valid Vapi class found'); VapiClass=null; return; }
    console.log('[SAMAY] Vapi loaded OK');
  }).catch(err => {
    console.warn('[SAMAY] vapi-bundle.js not found ‚Äî text mode only:', err.message);
    VapiClass = null;
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VAPI ‚Äî WIRE LISTENERS (exactly once)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function wireVapi(){
  if(vapiWired) return;
  vapiWired = true;

  vapi.on("call-start", () => {
    assistantBuffer=''; allUserSpeech=''; userUtterances=[]; pendingEvent=null;
    goActive();
  });

  vapi.on("call-end", () => { showToast("Call ended"); goIdle(); });

  vapi.on("speech-start", () => showTyping(true));
  vapi.on("speech-end",   () => showTyping(false));

  vapi.on("message", msg => {
    if(!msg || !msg.type) return; // FIX: guard null message

    /* ‚îÄ‚îÄ TOOL CALL ‚îÄ‚îÄ */
    if(msg.type === 'tool-calls' || msg.type === 'function-call'){
      const toolList = msg.toolCallList || msg.toolCalls ||
                       (msg.functionCall ? [{ function: msg.functionCall }] : []);
      toolList.forEach(tool => {
        if(!tool) return;
        const fn     = tool.function || tool;
        const fnName = (fn?.name || '').toLowerCase();
        let fnArgs   = fn?.arguments || tool?.arguments || '{}';
        if(!/schedule|meeting|calendar|event|book/.test(fnName)) return;
        if(typeof fnArgs === 'string'){ try{ fnArgs=JSON.parse(fnArgs); }catch(e){ fnArgs={}; } }

        let eventDate = null;
        if(fnArgs.date){
          const raw = String(fnArgs.date).trim();
          if(/^\d{4}-\d{2}-\d{2}T/.test(raw)) eventDate = new Date(raw);
          else if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){
            const [y,mo,dy]=raw.split('-').map(Number); eventDate=new Date(y,mo-1,dy);
          } else eventDate=new Date(raw);
          if(isNaN(eventDate?.getTime())) eventDate=null;
        }
        if(!eventDate) eventDate=new Date(Date.now()+86400000);

        pendingEvent = {
          title:    fnArgs.title||fnArgs.summary||fnArgs.eventName||fnArgs.meeting_title||'Meeting',
          date:     eventDate,
          time:     fnArgs.time||fnArgs.startTime||fnArgs.meeting_time||null,
          gcalLink: fnArgs.link||fnArgs.htmlLink||null
        };
        console.log('[VAPI TOOL] pendingEvent:', JSON.stringify(pendingEvent));
      });
      return;
    }

    /* ‚îÄ‚îÄ TOOL CALL RESULT ‚îÄ‚îÄ */
    if(msg.type === 'tool-call-result' || msg.type === 'function-call-result'){
      try{
        const result = typeof msg.result==='string' ? JSON.parse(msg.result) : (msg.result||{});
        if(result && (result.date||result.eventDate||result.htmlLink)){
          const rawDate = result.date||result.eventDate;
          let evDate = rawDate
            ? (/^\d{4}-\d{2}-\d{2}$/.test(String(rawDate).trim())
                ? (([y,mo,dy])=>new Date(y,mo-1,dy))(String(rawDate).trim().split('-').map(Number))
                : new Date(rawDate))
            : null;
          if(!evDate||isNaN(evDate.getTime())) evDate=new Date(Date.now()+86400000);
          const ev={
            title:    result.title||result.summary||result.eventName||'Meeting',
            date:     evDate, time:result.time||result.startTime||null,
            gcalLink: result.htmlLink||result.link||null
          };
          showToast('‚úÖ Meeting scheduled!',2500);
          setTimeout(()=>goCalendar(ev,'tool-result'),800);
        }
      }catch(e){ console.warn('[VAPI TOOL RESULT] parse error:',e); }
      return;
    }

    /* ‚îÄ‚îÄ TRANSCRIPT ‚îÄ‚îÄ */
    if(msg.type==="transcript" && msg.transcriptType==="final"){
      if(!msg.transcript||!msg.transcript.trim()) return; // FIX: skip blank
      showTyping(false);
      addMsg(msg.role==="user"?"user":"ai", msg.transcript);

      if(msg.role==="user"){
        allUserSpeech += ' ' + msg.transcript;
        userUtterances.push(msg.transcript);
      }
      if(msg.role==="assistant"){
        assistantBuffer += ' ' + msg.transcript;
        if(/meeting[\s_-]?confirmed/i.test(msg.transcript)){
          let ev;
          if(pendingEvent){
            ev = { ...pendingEvent };
          } else {
            let eventDate = parseDateFromText(allUserSpeech) || parseDateFromText(assistantBuffer);
            if(!eventDate) eventDate = new Date(Date.now()+86400000);
            let time = parseSpokenTime(allUserSpeech) || parseSpokenTime(assistantBuffer);

            const isDateWord = /(january|february|march|april|may|june|july|august|september|october|november|december|monday|tuesday|wednesday|thursday|friday|saturday|sunday|tomorrow|today|next|twenty|thirty|first|second|third|fourth|fifth|sixth|seventh|eighth|ninth|tenth|\d)/i;
            const isTimeWord = /(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|\d)\s*(am|pm|ist)/i;
            const isFiller   = /^(yes|no|okay|ok|sure|thanks|thank|hello|hi|namaste|please|proceed|blank|leave|skip|none|no title|am|pm)[.!?,]*$/i;

            let title = 'Meeting';
            for(const utt of [...userUtterances].reverse()){
              const u = utt.trim().replace(/[.!?,]+$/,'');
              if(u.length < 2 || isFiller.test(u) || isTimeWord.test(u) || isDateWord.test(u)) continue;
              title = u.charAt(0).toUpperCase() + u.slice(1);
              break;
            }
            ev = { title, date: eventDate, time, gcalLink: null };
          }
          showToast('‚úÖ Meeting scheduled!',2000);
          setTimeout(()=>goCalendar(ev, pendingEvent?'tool-call':'speech-parse'),500);
          pendingEvent=null; assistantBuffer='';
        }
      }
    }
  });

  vapi.on("error", err => {
    console.warn('[VAPI] error:', err);
    showToast("‚ö† " + (err?.message || err?.error?.message || "Connection error"), 5000);
    goIdle();
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VAPI ‚Äî START CALL (instance created once)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function startCall(){
  if(!VapiClass){ showToast("‚ö† Voice not ready ‚Äî use text mode or reload"); return; }
  goConnecting();
  try{
    if(!vapi){ vapi = new VapiClass(PUBLIC_KEY); wireVapi(); }
    await vapi.start(ASSISTANT_ID);
  } catch(e){
    console.error('[SAMAY] startCall error:', e);
    showToast("‚ö† " + (e.message || "Could not connect"));
    goIdle();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT LISTENERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
callBtn.addEventListener("click", startCall);

cancelBtn.addEventListener("click", () => {
  try{ if(vapi) vapi.stop(); } catch(e){ console.warn('[SAMAY] stop error:', e); }
  goIdle();
});

hangupBtn.addEventListener("click", () => {
  try{ if(vapi) vapi.stop(); } catch(e){ console.warn('[SAMAY] stop error:', e); }
  goIdle();
});

// FIX: back button ‚Äî return to appropriate state
backBtn.addEventListener("click", () => {
  scheduledEvent = null;
  // If vapi call is active, go back to active; else go idle
  if(vapi && appState === 'calendar') setState('active');
  else goIdle();
});

idleInput.addEventListener("keydown", e => {
  if(e.key === "Enter"){
    const v = idleInput.value.trim();
    if(!v) return;
    idleInput.value = "";
    setState('active');
    handleTextInput(v);
  }
});

activeInput.addEventListener("keydown", e => {
  if(e.key === "Enter"){
    const v = activeInput.value.trim();
    if(!v) return;
    activeInput.value = "";
    if(vapi?.send){
      addMsg("user", v);
      try{ vapi.send({ type:"add-message", message:{ role:"user", content:v } }); }
      catch(err){ console.warn('[SAMAY] vapi.send error:', err); }
    } else {
      handleTextInput(v);
    }
  }
});

// FIX: Escape key exits calendar (or cancels connecting)
document.addEventListener('keydown', e => {
  if(e.key === 'Escape'){
    if(appState === 'calendar'){
      scheduledEvent = null;
      if(vapi) setState('active'); else goIdle();
    } else if(appState === 'connecting'){
      try{ if(vapi) vapi.stop(); } catch(ex){}
      goIdle();
    }
  }
});

// FIX: prevent double-tap zoom on touch devices for action buttons
[callBtn, hangupBtn, cancelBtn, backBtn].forEach(btn => {
  btn.addEventListener('touchend', e => e.preventDefault(), { passive: false });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
renderCalendar();
loadVapi();
</script>
</body>
</html>